name: Github Actions Learning

on:
  workflow_dispatch:
  push:
    branches:
      - "master"

env:
  name: "abdelkader Boukert"

jobs:
  say-hello:
    runs-on: ubuntu-latest
    environment: Keys
    steps:
      - name: Run a one-line script
        run: echo "this Github action run by $name and use the key ${{secrets.AWS_ACCESS_KEY_ID}} and ${{secrets.TEST}}"

  job-2:
    outputs:
      V: ${{steps.S11.outputs.V}}
    runs-on: ubuntu-latest
    steps:
      - name: check rebo event
        id: S11
        run: |
          # 1. Saving a variable for the NEXT JOB to use
          echo "V=${{ env.name }} is doing ${{ github.event_name }}" >> $GITHUB_OUTPUT

          # 2. Creating a physical file to SAVE as an artifact
          echo "hi there this is test" >> test.txt

      - name: upload file
        id: S12
        uses: actions/upload-artifact@v4
        with:
          name: test
          path: test.txt

  job-3:
    runs-on: ubuntu-latest
    needs:
      - say-hello
      - job-2
    steps:
      - name: check rebo event
        id: S21
        run: echo "${{needs.job-2.outputs.V}}"
      - name: download file
        id: S22
        uses: actions/download-artifact@v4
        with:
          name: test
      - name: show file
        id: S23
        run: cat test.txt

  job-4:
    runs-on: ubuntu-latest

    needs: [job-3]

    steps:
      - name: edit the test file
        id: S41
        uses: actions/download-artifact@v4
        with:
          name: test

      - name: edit the file
        id: S42
        uses: actions/checkout@v4
      - name: set file
        run: cat src/config.py >> test.txt

      - name: push the file back
        uses: actions/upload-artifact@v4
        with:
          name: test-v2
          path: test.txt

  Deploy-Infra:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
      - run: npm install -g aws-cdk
      - name: CDK Deploy
        run: cdk deploy --require-approval never
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: "us-east-1"
  
          Docker-builder:
    runs-on: ubuntu-latest
    needs: [Deploy-Infra]
    environment: Keys

    env:
      NAME: abdelkader

    steps:
      - name: check code
        uses: actions/checkout@v4
      - name: set up docker
        uses: docker/setup-buildx-action@v3
      - name: build docker image
        run: docker build -t classifier:v1 .
      # 1. This "Logs in" the runner to your AWS Account
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Push to ECR using script
        run: |
          chmod +x ./push_to_aws.sh
          ./push_to_aws.sh -u ${{ secrets.AWS_ACCESS_KEY_ID }} -n classifier -t v1
